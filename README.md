# Витрина интернет-магазина и Сервис Платежей

## Описание

Этот проект представляет собой мультимодульное приложение, состоящее из двух основных компонентов:

• Витрина интернет-магазина: Веб-приложение для просмотра, добавления в корзину и покупки товаров. Разработано на Spring Boot с использованием реактивного стека (Spring WebFlux и Spring Data R2DBC).
• Сервис платежей: RESTful-сервис для обработки платежей.  Разработан на Spring Boot с использованием Spring WebFlux.
• В приложении «Витрина интернет-магазина» авторизация пользователя выполняется по логину/паролю
• Взаимодействия приложения "Витрина интернет-магазина", сервера авторизации (Keycloak) и RESTful-сервиса платежей осуществляется с использованием авторизации по OAuth2.

## Архитектура

Проект реализован как мультипроект (с использованием Gradle).  Два модуля (витрина и сервис платежей) взаимодействуют друг с другом через REST API, спецификация которого описана в OpenAPI.  Генерация клиента и контроллера на основе OpenAPI упрощает интеграцию.

## Технологии

Общие:

•   **Фреймворк:** Spring Boot (3.5.4)
•   **Язык программирования:** Java 21
•   **Сборка:** Gradle
•   **База данных:** PostgreSQL
•   **Шаблонизатор:** Thymeleaf
•   **Веб-фреймворк:** Spring WebFlux (Reactive Web)
•   **Доступ к данным:** Spring Data R2DBC (Reactive Relational Database Connectivity)
•   **Кеширование:** Redis
•   **Тестирование:** JUnit 5, Spring TestContext Framework, Spring Boot Test, Testcontainers, Reactor Test
•   **Сервлет-контейнер:** Netty (Embedded Reactive Server)
•   **Контейнеризация:** Docker
•   **Безопасность:** Spring Security
•   **Авторизация межсервисного взаимодействия:** Keycloak

## Необходимые условия

Для работы приложения необходимо установить следующее программное обеспечение:

•   Java 21 JDK
•   Gradle
•   Экземпляр PostgreSQL
•   Redis сервер
•   Keycloak
•   Docker
•   Docker Compose

## Функциональность

Витрина интернет-магазина:

•   **Каталог товаров:**
•   Отображение списка товаров с изображениями, названиями, ценами и кнопками добавления в корзину.
•   Пагинация результатов (варианты: 10, 20, 50, 100 товаров на странице).
•   Поиск товаров по названию и описанию.
•   Фильтрация товаров по цене и сортировка по алфавиту.
•   **Страница товара:**
•   Детальная информация о выбранном товаре (название, изображение, описание, цена).
•   Возможность добавления и удаления товара из корзины.
•   Изменение количества товара в корзине непосредственно на странице товара.
•   **Корзина:**
•   Отображение списка выбранных товаров с указанием количества, цены и общей суммы.
•   Возможность удаления товаров из корзины и изменения их количества.
•   Кнопка "Оформить заказ".
•   **История заказов:**
•   Список всех оформленных заказов пользователя с указанием даты, номера заказа и общей суммы.
•   **Страница заказа (детализация):**
•   Список товаров, входящих в конкретный заказ (изображение, название, цена, количество).
•   **Оформление заказа:**
•   При нажатии на кнопку "Оформить заказ" происходит взаимодействие с RESTful-сервисом платежей.
•   Сервис платежей проверяет достаточность баланса пользователя. Если баланс недостаточен, заказ не оформляется, и отображается соответствующее сообщение об ошибке.
•   При успешной оплате отображается страница подтверждения с деталями заказа.
•   Эмуляция процесса оформления заказа (интеграция с RESTful-сервисом платежей).
•   **Добавление нового товара (только для пользователя с правами администратора):**
•   Веб-интерфейс для загрузки информации о новых товарах на витрину (включая загрузку изображений, указание названия, описания и цены).  *Примечание: Этот функционал доступен только для пользователей с ролью администратора.*
•   **Управление пользователями:**
•   Регистрация нового пользователя.
•   Возможность выбора роли "admin" при регистрации.
•   Аутентификация пользователя (логин).

RESTful-сервис платежей:

• Предоставляет два реактивных HTTP-эндпоинта:
* Получение баланса на счёте (фиксированный начальный баланс).
* Осуществление платежа (вычитание суммы заказа из баланса). Возвращает подтверждение об успехе или ошибку.
• Обмен данными в формате JSON.

## Настройка и конфигурация

Приложение состоит из двух частей: "Витрина интернет-магазина" и RESTful-сервис платежей.  Для работы обеих частей необходима настройка базы данных и конфигурационных файлов.

1. Настройка базы данных:

• Создайте две базы данных PostgreSQL: одну для "Витрины интернет-магазина", другую для сервиса платежей.
• Схемы баз данных создаются автоматически с помощью Spring Data R2DBC.

2. Конфигурация приложения "Витрина интернет-магазина":

Отредактируйте файл src/main/resources/application.yml и настройте следующие параметры:
•   **Директория для загрузки изображений:**

```yaml
    blog.image.upload.dir: /path/to/your/upload/directory
```
Убедитесь, что указанная директория существует, и у приложения есть права на запись в нее. 
Изображения для первоначальной загрузки данных в таблицу товаров находятся в папке images в корне проекта.

•   Рабочая база данных:
```yaml
     spring:
       r2dbc:
       url: ${INTERSHOP_DB_URL}
       username: ${INTERSHOP_DB_USERNAME}
       password: ${INTERSHOP_DB_PASSWORD}
       pool:
         max-size: 20
         initial-size: 10
         validation-query: SELECT 1
```
Замените  ${INTERSHOP_DB_URL}, ${INTERSHOP_DB_USERNAME} и ${INTERSHOP_DB_PASSWORD} на ваши данные.

• Redis (кеширование):
```yaml
    spring:
      data:
        redis:
          host: ${REDIS_HOST}
          port: 6379
          cache:
            redis:
              time-to-live: PT5S
```
Убедитесь, что у вас запущен сервер Redis.  Замените ${REDIS_HOST} на адрес вашего Redis сервера.

• Сервис платежей:
```yaml
    cookie:
      max:
        age:
          seconds: 86400
      balance:
        service:
          url: http://${PAYMENT_SERVICE_HOST}:8081
```
• **OAuth2 (Keycloak):**

```yaml
spring:
   security:
    oauth2:
     client:
      provider:
       keycloak:
        issuer-uri: ${KEYCLOAK_ISSUER_HOST_AND_PORT} # URL сервера Keycloak, включая realm (обязательно, задается через переменную окружения)
      registration:
       store:
        client-id: internet-shop # Идентификатор клиента, зарегистрированного в Keycloak (по умолчанию: internet-shop)
        client-secret: ${KEYCLOAK_CLIENT_SECRET} # Секрет клиента, зарегистрированного в Keycloak (обязательно, задается через переменную окружения)
        client-authentication-method: client_secret_post # Метод аутентификации клиента (по умолчанию: client_secret_post)
```
•  KEYCLOAK_ISSUER_HOST_AND_PORT - URL сервера Keycloak, включая область (realm). Это обязательная переменная окружения. Пример: http://localhost:8082/realms/myrealm
•  KEYCLOAK_CLIENT_SECRET - Секрет клиента, зарегистрированного в Keycloak. Это обязательная переменная окружения.
•  client-id - Идентификатор клиента, зарегистрированного в Keycloak. По умолчанию internet-shop.

3. Конфигурация сервиса платежей:

Отредактируйте файл src/main/resources/application.yml сервиса платежей и настройте следующие параметры:

• Порт:
```yaml
 server:
    port: 8081
```

• База данных:

```yaml
  spring:
    r2dbc:
      url: ${PAYMENT_SERVICE_DB_URL}
      username: ${PAYMENT_SERVICE_DB_USERNAME}
      password: ${PAYMENT_SERVICE_DB_PASSWORD}
      pool:
        max-size: 20
        initial-size: 10
        validation-query: SELECT 1
```
Замените ${PAYMENT_SERVICE_DB_URL}, ${PAYMENT_SERVICE_DB_USERNAME} и ${PAYMENT_SERVICE_DB_PASSWORD} на ваши данные для базы данных сервиса платежей.  Обратите внимание, что это отдельный файл application.yml для сервиса платежей.

Перед запуском убедитесь, что все переменные окружения, используемые в файлах application.yml (например, INTERSHOP_DB_URL, REDIS_HOST, PAYMENT_SERVICE_HOST, KEYCLOAK_ISSUER_HOST_AND_PORT, KEYCLOAK_CLIENT_SECRET и другие),  установлены корректно.

## Сборка и запуск

### 1. В среде разработки

1. Импортируйте проект в вашу IDE (IntelliJ IDEA, Eclipse и т.д.).  Убедитесь, что Gradle корректно настроен в IDE.
2. Настройте подключение к базе данных PostgreSQL (см. application.yml).
3. Запустите сервер Redis.
```bash 
   docker run --name redis-server -it --rm -p 6379:6379 redis:7.4.2-bookworm 
```
4. Запустите сервер авторизации Keycloak
```bash
docker run -d -p 8082:8080 --name keycloak ^
  -e KC_BOOTSTRAP_ADMIN_USERNAME=admin ^
  -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin ^
  quay.io/keycloak/keycloak:26.1.3 start-dev
```
После запуска Keycloak, необходимо создать клиента со следующими параметрами:

•  Client ID: internet-shop
•  Client authentication: ON
•  Service accounts roles: checked

Настройте подключение к Keycloak в файлах application.yml модулей store и payment-service, указав корректные параметры (URL, Realm, Client ID, Client Secret).
    
5. Выполните сборку и запуск приложения "Витрина интернет-магазина" используя возможности вашей IDE.
6. Для запуска тестов убедитесь, что Docker запущен.  IDE обычно позволяет запускать тесты непосредственно из среды разработки.  

### 2. Локально (из командной строки)

Сборка JAR:  
```bash
./gradlew bootRun
```
Запуск приложения "Витрина интернет-магазина":

1. Запустите сервер Redis. 
```bash 
   docker run --name redis-server -it --rm -p 6379:6379 redis:7.4.2-bookworm 
```
2. Запустите сервер авторизации Keycloak с настроенным клиентом (как описано в пункте 4 предыдущего раздела)

3. Запуск сервиса платежей:
```bash 
./gradlew :payment-service:bootRun  
```
4. Запуск приложения "Витрина интернет-магазина":
```bash 
./gradlew :store:bootRun  
```

Запуск тестов (убедитесь, что Docker установлен и запущен):    
```bash 
./gradlew :test
```

### 3. Сборка и запуск с использованием Docker

**1. Настройка переменных окружения:

Для работы приложения и сервиса платежей необходимо установить следующие переменные окружения:

•   INTERSHOP_DB_NAME: Имя базы данных основного приложения.
•   INTERSHOP_DB_USERNAME: Имя пользователя для базы данных основного приложения.
•   INTERSHOP_DB_PASSWORD: Пароль пользователя для базы данных основного приложения.
•   PAYMENT_SERVICE_DB_NAME: Имя базы данных сервиса платежей.
•   PAYMENT_SERVICE_DB_USERNAME: Имя пользователя для базы данных сервиса платежей.
•   PAYMENT_SERVICE_DB_PASSWORD: Пароль пользователя для базы данных сервиса платежей.
•   UPLOAD_IMAGES_DIR: Путь к директории для загрузки изображений (относительно корневого каталога проекта).
•   KEYCLOAK_CLIENT_SECRET: Секрет клиента, зарегистрированного в Keycloak

**2. Сборка и запуск Docker-контейнера:**

•   Соберите проект с помощью Gradle:
```bash
./gradlew build
```
•   Запустите Docker Compose:
```bash
docker-compose up --build
```

## Доступ к приложению

После запуска приложения, веб-интерфейс "Витрины интернет-магазина" будет доступен по адресу:

•  http://localhost:8080/catalog или http://localhost:8080/catalog/items (просмотр каталога)
•  http://localhost:8080/catalog/products/new (добавление новых товаров, только для пользователей с правами администратора)

Сервис платежей: http://localhost:8081


